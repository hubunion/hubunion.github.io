import{o}from"./index.5f4f494e.js";import"./comlink.bfd883af.js";class r{constructor(){this.db=null,o("settings-store").then(async t=>{this.db=t;const e=await t.get("settings","handler");e&&(document.title=`${e.name} | PWA Edit`,this.handler=e)}),"launchQueue"in window&&launchQueue.setConsumer(t=>{if(!!t.files.length)for(const e of t.files)this.open(e)}),window.addEventListener("beforeunload",()=>{this.previewWindow&&this.previewWindow.close()})}async open(t){try{let e;t instanceof FileSystemFileHandle?e=t:[e]=await window.showOpenFilePicker({types:[{description:"Markdown files",accept:{"text/markdown":[".md",".markdown"]}}]}),document.title=`${e.name} | PWA Edit`;const s=await(await e.getFile()).text();this.handler=e,this.editor.setContent(s),await this.db.put("settings",e,"handler")}catch(e){console.error(e)}}async save(){const t=this.handler||await this.db.get("settings","handler");if(!t)await this.saveAs();else try{const e=await t.createWritable();await e.write(this.editor.content()),await e.close()}catch(e){console.error(e)}}async saveAs(){try{const t=await window.showSaveFilePicker({types:[{description:"Markdown file",accept:{"text/markdown":[".md"]}}]});this.handler=t,await this.db.put("settings",t,"handler"),await this.save()}catch(t){console.error(t)}}async reset(){this.editor.setContent(""),this.handler=null,document.title="PWA Edit",await this.db.delete("settings","handler")}async preview(){if(this.previewWindow){this.previewWindow.close(),this.previewWindow=null;return}const t="menubar=0,toolbar=0,status=0,location=0",{screens:e}=await window.getScreenDetails(),i=e.find(n=>n.isPrimary),s=i.availWidth/2;this.previewWindow=window.open("/preview/index.html","Markdown preview",`${t},left=${s},top=${i.availTop},height=${i.availHeight},width=${s}`)}async focus(){document.fullscreenElement?(document.exitFullscreen(),this.wakeLock&&(this.wakeLock.release(),this.wakeLock=null)):("wakeLock"in navigator&&(this.wakeLock=await navigator.wakeLock.request()),await document.body.requestFullscreen())}}class h extends r{constructor(t,e){super(),this._toggle=t.querySelector(".actions--toggle"),this._menu=t.querySelector(".actions--menu"),this._toggle.addEventListener("click",this._toggleMenu.bind(this)),t.addEventListener("keydown",this._captureTab.bind(this),{bubble:!1}),document.body.addEventListener("keydown",this._triggerActions.bind(this)),this._buttons=[...this._menu.querySelectorAll(".actions--action")],this.editor=e;for(const i of this._buttons){const s=i.id;i.addEventListener("click",this[s].bind(this))}}_toggleMenu(){if(this._menu.ariaHidden==="true"){this._menu.ariaHidden=!1,this._toggle.ariaExpanded=!0,this._toggle.ariaLabel="Close actions";for(const t of this._buttons)t.tabIndex=0}else{this._menu.ariaHidden=!0,this._toggle.ariaExpanded=!1,this._toggle.ariaLabel="Open actions";for(const t of this._buttons)t.tabIndex=1}}_captureTab(t){if(this._menu.ariaHidden!=="true"){const e=t.key==="Tab",i=t.key==="Escape",s=t.shiftKey,n=t.target;n===this._buttons[this._buttons.length-1]&&e&&!s?(t.preventDefault(),this._toggle.focus()):n===this._toggle&&e&&s?(t.preventDefault(),this._buttons[this._buttons.length-1].focus()):i&&(this._toggle.focus(),this._toggleMenu())}}_triggerActions(t){if(t.metaKey)switch(t.code){case"KeyS":t.preventDefault(),t.shiftKey?this.saveAs():this.save();break;case"KeyO":t.preventDefault(),this.open();break;case"KeyF":t.shiftKey&&(t.preventDefault(),this.focus());break;case"KeyP":t.shiftKey&&(t.preventDefault(),this.preview());break;case"KeyR":t.shiftKey&&(t.preventDefault(),this.reset());break}}}export{h as Menu};
